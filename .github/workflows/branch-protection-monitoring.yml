name: Branch Protection Audit

on:
  # schedule:
  #   - cron: '0 3 * * 1'  # Runs every Monday at 3 AM UTC
  workflow_dispatch:      # ✅ Manual trigger from GitHub UI
  push:                   # ✅ Trigger on any push to test behavior
    branches:
      - main               # or your preferred branch

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      ORG_NAME: devops-saddam
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Run Branch Protection Audit
        run: |
          python - <<'EOF'
          import os, requests, json

          ORG = os.getenv("ORG_NAME")
          GH_TOKEN = os.getenv("GITHUB_TOKEN")
          SLACK_WEBHOOK = os.getenv("SLACK_WEBHOOK")

          headers = {
              "Authorization": f"Bearer {GH_TOKEN}",
              "Accept": "application/vnd.github+json"
          }

          def get_repos():
              repos = []
              page = 1
              while True:
                  resp = requests.get(
                      f"https://api.github.com/orgs/{ORG}/repos?per_page=100&page={page}",
                      headers=headers
                  )
                  if resp.status_code != 200:
                      break
                  data = resp.json()
                  if not data:
                      break
                  repos.extend(data)
                  page += 1
              return repos

          def get_branch_protection(repo, branch):
              url = f"https://api.github.com/repos/{ORG}/{repo}/branches/{branch}/protection"
              resp = requests.get(url, headers=headers)
              return resp.json() if resp.status_code == 200 else None

          repos = get_repos()
          missing_configs, mismatched = [], []

          for repo in repos:
              repo_name = repo["name"]
              default_branch = repo["default_branch"]

              branches_resp = requests.get(
                  f"https://api.github.com/repos/{ORG}/{repo_name}/branches",
                  headers=headers
              )
              branches = branches_resp.json() if branches_resp.status_code == 200 else []

              protection = get_branch_protection(repo_name, default_branch)

              # Check for mismatched branch protection
              for br in branches:
                  if br["name"] != default_branch:
                      other_protection = get_branch_protection(repo_name, br["name"])
                      if other_protection:
                          mismatched.append({
                              "repo": repo_name,
                              "default": default_branch,
                              "protected": br["name"]
                          })

              # Validate protection on default branch
              if not protection:
                  missing_configs.append({
                      "repo": repo_name,
                      "missing": ["Branch protection rule not found on default branch"]
                  })
                  continue

              missing = []
              reqs = protection.get("required_pull_request_reviews")

              if not reqs:
                  missing.append("Require pull request before merging not enabled")
              elif reqs.get("required_approving_review_count", 0) < 2:
                  missing.append(f"Required approving reviews is {reqs.get('required_approving_review_count', 0)} (expected 2)")

              if protection.get("allow_force_pushes", {}).get("enabled"):
                  missing.append("Force pushes are allowed")

              if protection.get("enforce_admins", {}).get("enabled") == False:
                  missing.append("Admins can bypass protection")

              if missing:
                  missing_configs.append({
                      "repo": repo_name,
                      "missing": missing
                  })

          # --- Build Slack message payload ---
          blocks = []

          if missing_configs:
              blocks.append({
                  "type": "header",
                  "text": {"type": "plain_text", "text": "❌ Missing / Misconfigured Branch Protections"}
              })
              for m in missing_configs:
                  detail_text = "\n".join([f"• {i}" for i in m["missing"]])
                  blocks.append({
                      "type": "section",
                      "text": {
                          "type": "mrkdwn",
                          "text": f"*Repository:* `{m['repo']}`\n{detail_text}"
                      }
                  })
                  blocks.append({"type": "divider"})

          if mismatched:
              blocks.append({
                  "type": "header",
                  "text": {"type": "plain_text", "text": "⚠️ Mismatched Branch Protections"}
              })
              for mm in mismatched:
                  blocks.append({
                      "type": "section",
                      "text": {
                          "type": "mrkdwn",
                          "text": f"*Repository:* `{mm['repo']}`\nProtection applied to `{mm['protected']}` but default branch is `{mm['default']}`"
                      }
                  })
                  blocks.append({"type": "divider"})

          if not blocks:
              blocks = [{
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": "✅ All repositories are fully compliant."}
              }]

          payload = {"blocks": blocks}
          requests.post(SLACK_WEBHOOK, json=payload)
          EOF
