name: Branch Protection Audit

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      ORG_NAME: devops-saddam
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Run Branch Protection + Ruleset Audit
        run: |
          python - <<'EOF'
          import os, requests, json

          ORG = os.getenv("ORG_NAME")
          GH_TOKEN = os.getenv("GITHUB_TOKEN")
          SLACK_WEBHOOK = os.getenv("SLACK_WEBHOOK")

          headers = {
              "Authorization": f"Bearer {GH_TOKEN}",
              "Accept": "application/vnd.github+json"
          }

          def get_repos():
              repos = []
              page = 1
              while True:
                  resp = requests.get(
                      f"https://api.github.com/orgs/{ORG}/repos?per_page=100&page={page}",
                      headers=headers
                  )
                  if resp.status_code != 200:
                      break
                  data = resp.json()
                  if not data:
                      break
                  repos.extend(data)
                  page += 1
              return repos

          def get_branch_protection(repo, branch):
              url = f"https://api.github.com/repos/{ORG}/{repo}/branches/{branch}/protection"
              resp = requests.get(url, headers=headers)
              return resp.json() if resp.status_code == 200 else None

          def get_rulesets(repo):
              url = f"https://api.github.com/repos/{ORG}/{repo}/rulesets"
              resp = requests.get(url, headers=headers)
              return resp.json() if resp.status_code == 200 else []

          repos = get_repos()
          missing_configs, mismatched = [], []

          for repo in repos:
              repo_name = repo["name"]
              default_branch = repo["default_branch"]

              protection = get_branch_protection(repo_name, default_branch)
              rulesets = get_rulesets(repo_name)

              has_active_ruleset = False
              ruleset_findings = []

              for rs in rulesets:
                  if rs.get("enforcement") == "active":
                      conditions = rs.get("conditions", {})
                      branch_conditions = conditions.get("ref_name", {}).get("include", [])
                      # match refs/heads/main or main
                      if any(default_branch in b for b in branch_conditions):
                          has_active_ruleset = True
                          rules = [r.get("type") for r in rs.get("rules", [])]
                          ruleset_findings.append({
                              "name": rs["name"],
                              "rules": rules
                          })

              if not protection and not has_active_ruleset:
                  missing_configs.append({
                      "repo": repo_name,
                      "missing": ["No active branch protection or ruleset found for default branch"]
                  })
                  continue

              missing = []

              # Check legacy branch protection if exists
              if protection:
                  reqs = protection.get("required_pull_request_reviews")
                  if not reqs:
                      missing.append("Require pull request before merging not enabled (classic)")
                  elif reqs.get("required_approving_review_count", 0) < 2:
                      missing.append(f"Required approving reviews = {reqs.get('required_approving_review_count', 0)} (expected 2)")
                  if protection.get("allow_force_pushes", {}).get("enabled"):
                      missing.append("Force pushes allowed")
                  if protection.get("enforce_admins", {}).get("enabled") == False:
                      missing.append("Admins can bypass protection")

              # Check ruleset coverage
              elif has_active_ruleset:
                  for rs in ruleset_findings:
                      rule_types = rs["rules"]
                      if "pull_request" not in rule_types:
                          missing.append("Require pull request before merging not enabled (ruleset)")
                      if "required_approving_review_count" not in rule_types:
                          missing.append("Required approving reviews rule missing")
                      if "non_fast_forward" not in rule_types:
                          missing.append("Non-fast-forward (merge enforcement) rule missing")

              if missing:
                  missing_configs.append({
                      "repo": repo_name,
                      "missing": missing
                  })

          # Build Slack report
          blocks = []

          if missing_configs:
              blocks.append({
                  "type": "header",
                  "text": {"type": "plain_text", "text": "❌ Missing / Misconfigured Protections"}
              })
              for m in missing_configs:
                  detail = "\n".join([f"• {i}" for i in m["missing"]])
                  blocks.append({
                      "type": "section",
                      "text": {"type": "mrkdwn", "text": f"*Repository:* `{m['repo']}`\n{detail}"}
                  })
                  blocks.append({"type": "divider"})

          if mismatched:
              blocks.append({
                  "type": "header",
                  "text": {"type": "plain_text", "text": "⚠️ Mismatched Branch Protections"}
              })
              for mm in mismatched:
                  blocks.append({
                      "type": "section",
                      "text": {"type": "mrkdwn", "text": f"*Repository:* `{mm['repo']}`\nProtected `{mm['protected']}` but default branch is `{mm['default']}`"}
                  })
                  blocks.append({"type": "divider"})

          if not blocks:
              blocks = [{
                  "type": "section",
                  "text": {"type": "mrkdwn", "text": "✅ All repositories are compliant (classic or ruleset)."}
              }]

          requests.post(SLACK_WEBHOOK, json={"blocks": blocks})
          EOF
