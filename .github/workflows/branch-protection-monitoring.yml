name: Branch Protection Detailed Audit

on:
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      ORG_NAME: devops-saddam
      GITHUB_TOKEN: ${{ secrets.RULESET_PAT }}
      DEBUG: "true"
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Run Detailed Branch Protection Audit
        run: |
          python - <<'EOF'
          import os, requests, json, sys

          ORG = os.getenv("ORG_NAME")
          TOKEN = os.getenv("GITHUB_TOKEN")
          DEBUG = os.getenv("DEBUG", "false").lower() == "true"

          def log(msg, lvl="INFO"):
              print(f"[{lvl}] {msg}", flush=True)

          def dbg(msg):
              if DEBUG: log(msg, "DEBUG")

          headers = {
              "Authorization": f"Bearer {TOKEN}",
              "Accept": "application/vnd.github+json"
          }

          def get_json(url):
              r = requests.get(url, headers=headers, timeout=30)
              if r.status_code == 200:
                  return r.json()
              elif r.status_code == 404:
                  return None
              else:
                  log(f"Failed GET {url} → {r.status_code}: {r.text[:300]}", "WARN")
                  return None

          def get_repos():
              repos, page = [], 1
              while True:
                  url = f"https://api.github.com/orgs/{ORG}/repos?per_page=100&page={page}"
                  data = get_json(url)
                  if not data: break
                  repos.extend(data)
                  if len(data) < 100: break
                  page += 1
              return repos

          def check_branch_protection(repo, branch):
              url = f"https://api.github.com/repos/{ORG}/{repo}/branches/{branch}/protection"
              return get_json(url)

          def get_rulesets(repo):
              url = f"https://api.github.com/repos/{ORG}/{repo}/rulesets"
              return get_json(url) or []

          # --- START ---
          repos = get_repos()
          log(f"Total repositories found: {len(repos)}")
          for r in repos:
              log(f"→ {r['name']}")

          missing, ok = [], []

          for idx, repo in enumerate(repos, start=1):
              name = repo["name"]
              default_branch = repo["default_branch"]
              log(f"\n[{idx}/{len(repos)}] Checking repository: {name}")
              log(f"Default branch for {name} is '{default_branch}'")

              # --- Check for Classic Branch Protection ---
              protection = check_branch_protection(name, default_branch)
              if protection:
                  log(f"Branch protection rule FOUND for {name}")
                  issues = []

                  pr_req = protection.get("required_pull_request_reviews")
                  if not pr_req:
                      issues.append("Require pull request before merging not enabled")
                  else:
                      count = pr_req.get("required_approving_review_count", 0)
                      if count < 2:
                          issues.append(f"Approvals set to {count}, expected 2")
                      if not pr_req.get("dismiss_stale_reviews", False):
                          issues.append("Dismiss stale pull request approvals not enabled")

                  if issues:
                      log(f"{name}: ❌ Misconfigured → {', '.join(issues)}")
                      missing.append({"repo": name, "issues": issues})
                  else:
                      log(f"{name}: ✅ Classic branch protection compliant")
                      ok.append(name)
                  continue

              log(f"No classic branch protection found for {name}, checking Rulesets...")

              # --- Check Rulesets if no branch protection ---
              rulesets = get_rulesets(name)
              if not rulesets:
                  log(f"{name}: ❌ No rulesets found → No protection")
                  missing.append({"repo": name, "issues": ["No branch protection or ruleset configured"]})
                  continue

              issues = []
              found_active = False
              for rs in rulesets:
                  if rs.get("enforcement") != "active":
                      continue
                  found_active = True
                  log(f"Active Ruleset found: {rs['name']}")
                  rules = [r.get("type") for r in rs.get("rules", [])]
                  dbg(f"Rules in {rs['name']}: {rules}")

                  if "restrict_deletions" not in rules:
                      issues.append("Restrict deletions not enabled")
                  if "pull_request" not in rules:
                      issues.append("Require pull request rule missing")
                  if "required_approving_review_count" not in rules:
                      issues.append("Required approving reviews rule missing or not set to 2")
                  if "non_fast_forward" not in rules:
                      issues.append("Block force pushes not enabled")

              if not found_active:
                  issues.append("No active rulesets found")

              if issues:
                  log(f"{name}: ❌ Misconfigured → {', '.join(issues)}")
                  missing.append({"repo": name, "issues": issues})
              else:
                  log(f"{name}: ✅ Ruleset-based protection compliant")
                  ok.append(name)

          # --- SUMMARY ---
          log("\n========= AUDIT SUMMARY =========")
          log(f"Total repositories: {len(repos)}")
          log(f"Compliant: {len(ok)}")
          log(f"Issues: {len(missing)}")
          if missing:
              log("\nRepositories with issues:")
              for m in missing:
                  log(f"- {m['repo']}: {', '.join(m['issues'])}")
          log("=================================")

          EOF
